graph TD
    Start([Initialize Walk-Forward Backtest]) --> Config[Configure Parameters:<br/>Date Range, Model Type, Windows, Per-Player Mode]

    Config --> LoadDates[Load Slate Dates in Range]
    LoadDates --> LoopStart{For Each Test Date}

    LoopStart -->|Next| LoadSlate[Load Slate Data:<br/>Salaries, Schedule, Odds, Injuries]
    LoadSlate --> CheckSalary{Salary Data?}
    CheckSalary -->|No| LoopStart

    CheckSalary -->|Yes| LoadHistory[Load Historical Player Logs<br/>Before test_date only]
    LoadHistory --> ModelDecision{Per-Player Models?}

    ModelDecision -->|No| Recal1{Recalibrate?}
    Recal1 -->|Yes| BuildTrain[Build Training Features]

    BuildTrain --> RollStats[Rolling Statistics:<br/>Windows 3,5,10<br/>MA + StdDev<br/>pts,reb,ast,stl,blk,mins]
    RollStats --> EWMA[EWMA Features:<br/>Span=3<br/>Recent game weighting]

    EWMA --> TrainGlobal[Train Global Model<br/>All players, XGBoost/RF]
    TrainGlobal --> CacheGlobal[Cache Model + Save]
    CacheGlobal --> BuildSlate[Build Slate Features]

    Recal1 -->|No| ReuseGlobal[Use Cached Model]
    ReuseGlobal --> BuildSlate
    BuildSlate --> ProjectGlobal[Generate Projections]

    ModelDecision -->|Yes| Recal2{Recalibrate?}
    Recal2 -->|Yes| PerPlayerLoop{For Each Player}

    PerPlayerLoop --> FilterPlayer[Filter Player History]
    FilterPlayer --> CheckGames{Enough Games?}
    CheckGames -->|No| PerPlayerLoop

    CheckGames -->|Yes| BuildPlayerTrain[Build Player Features]
    BuildPlayerTrain --> PlayerRoll[Player Rolling Stats]
    PlayerRoll --> PlayerEWMA[Player EWMA]
    PlayerEWMA --> TrainPlayer[Train Player Model]
    TrainPlayer --> CachePlayer[Cache + Save Model]
    CachePlayer --> ProjectPlayer[Player Projection]
    ProjectPlayer --> PerPlayerLoop

    Recal2 -->|No| ReusePlayer[Use Cached Models]
    ReusePlayer --> PerPlayerLoop
    PerPlayerLoop -->|Done| CombineProj[Combine Projections]

    ProjectGlobal --> LoadActuals[Load Box Scores<br/>Calculate DK Points]
    CombineProj --> LoadActuals
    LoadActuals --> CheckActuals{Actuals?}
    CheckActuals -->|No| LoopStart

    CheckActuals -->|Yes| Merge[Merge on playerID]
    Merge --> CalcMetrics[Calculate MAPE, RMSE, Correlation]
    CalcMetrics --> StoreResults[Store Daily Results]
    StoreResults --> LoopStart

    LoopStart -->|Done| Aggregate[Aggregate Statistics]
    Aggregate --> End([Return Summary])

    style RollStats fill:#e1f5ff
    style EWMA fill:#e1f5ff
    style PlayerRoll fill:#ffe1f5
    style PlayerEWMA fill:#ffe1f5
    style CalcMetrics fill:#fff4e1
    style TrainGlobal fill:#e8f5e9
    style TrainPlayer fill:#fce4ec
